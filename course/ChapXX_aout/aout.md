[toc]

突然想起来，a.out格式还是要稍微说下，毕竟在linux0.12中目标文件用的就是这种格式。 在进程加载那个章节还是会用到的。

学会了a.out，以后对ELF格式的学习也会有所帮助。

请注意，这里我们要讨论几个不同的格式：
1. `a.out` from GCC 1.40 used by Linux 0.12
2. `a.out` generated by bcc(dev86) or ld86(dev86)
4. `object format` from as86(dev86)

本章主要知识点如下：

    1. a.out 头结构
    2. a.out 内存布局
    3. 重定位
    4. symbol
    5. string


---------------------------
# a.out - (bcc or ld86)

#### HEADER
```
struct  exec {                /* a.out header */
    unsigned char a_magic[2]; /* magic number */
    unsigned char a_flags;    /* flags, see below */
    unsigned char a_cpu;      /* cpu id */
    unsigned char a_hdrlen;   /* length of header */
    unsigned char a_unused;   /* reserved for future use */
    unsigned short a_version; /* version stamp (not used at present) */
    long      a_text;     /* size of text segement in bytes */
    long      a_data;     /* size of data segment in bytes */
    long      a_bss;      /* size of bss segment in bytes */
    long      a_entry;    /* entry point */
    long      a_total;    /* total memory allocated */
    long      a_syms;     /* size of symbol table */

    /* SHORT FORM ENDS HERE */ 
    long      a_trsize;   /* text relocation size */ 
    long      a_drsize;   /* data relocation size */ 
    long      a_tbase;    /* text relocation base */ 
    long      a_dbase;    /* data relocation base */ 
};
```

#### MAGIC NUMBER

    #define A_MAGIC0      (unsigned char) 0x01
    #define A_MAGIC1      (unsigned char) 0x03

##### FLAGS
    #define A_UZP   0x01    /* unmapped zero page (pages) */
    #define A_PAL   0x02    /* page aligned executable */
    #define A_NSYM  0x04    /* new style symbol table */
    #define A_STAND 0x08    /* standalone executable */
    #define A_EXEC  0x10    /* executable */
    #define A_SEP   0x20    /* separate I/D */
    #define A_PURE  0x40    /* pure text */
    #define A_TOVLY 0x80    /* text overlay */

#### CPU ID
    #define A_NONE  0x00    /* unknown */
    #define A_I8086 0x04    /* intel i8086/8088 */
    #define A_I80386 0x10   /* intel i80386 */


#### Symbol
```
struct nlist {          /* symbol table entry */
    char n_name[8];       /* symbol name */
    long n_value;         /* value */
    unsigned char n_sclass;   /* storage class */
    unsigned char n_numaux;   /* number of auxiliary entries (not used) */
    unsigned short n_type;    /* language base and derived type (not used) */
};
```

    /* Low 3 bits of storage class (section). */
    #define N_SECT        07    /* section mask */
    #define N_UNDF        00    /* undefined */
    #define N_ABS         01    /* absolute */
    #define N_TEXT        02    /* text */
    #define N_DATA        03    /* data */
    #define N_BSS         04    /* bss */
    #define N_COMM        05    /* (common) */

    /* High 5 bits of storage class. (八进制)*/
    #define N_CLASS     0370    /* storage class mask */
    #define C_NULL
    #define C_EXT       0020    /* external symbol */
    #define C_STAT      0030    /* static */


#### Diagram
![a.out_ld86](a.out_ld86.jpg)


---------------------------
# a.out - (bcc or ld86)